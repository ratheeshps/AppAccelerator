trigger:
  - main

pool: 'MySelfHost'

variables:
  buildConfiguration: 'Release'
  dotnetVersion: '10.0.x'
  projectPath: '$(Build.SourcesDirectory)/App'
  apiProjectPath: '$(projectPath)/src/Payment.Processing.API'
  testProjectPath: '$(projectPath)/test/Payment.Processing.API.UnitTests'
  artifactName: 'drop'

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Unit Test'
        steps:
          - checkout: self
            fetchDepth: 0
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              version: $(dotnetVersion)

          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet packages'
            inputs:
              command: 'restore'
              projects: '$(projectPath)/**/*.csproj'
          - task: SonarCloudPrepare@4
            inputs:
              SonarQube: 'SonarCloud'
              organization: 'ratheeshazure01'
              scannerMode: 'dotnet'
              dotnetScannerVersion: '11.0.0.126294'
              projectKey: '$(SonarCloudProjectKey)'
              projectName: 'AppAccelerator'
              extraProperties: |
                # Additional properties that will be passed to the scanner, 
                # Put one key=value per line, example:
                sonar.exclusions=**/*.bin, **/*.obj
                sonar.cs.opencover.reportsPaths=$(Agent.TempDirectory)/**/*opencover.xml
          # - task: SonarCloudPrepare@4
          #   inputs:
          #     SonarQube: 'SonarCloud'
          #     organization: 'ratheeshazure01'
          #     scannerMode: 'dotnet'
          #     dotnetScannerVersion: '10.0'
          #     projectKey: '$(SonarCloudProjectKey)'
          #     projectName: 'AppAccelerator'
          #     extraProperties: |
          #       sonar.cs.opencover.reportsPaths=$(Agent.TempDirectory)/**/*opencover.xml
          #       sonar.exclusions=**/bin/**,**/obj/** ,**/Program.cs,**/OpenApiXmlCommentSupport.generated.cs
          #       sonar.coverage.exclusions=**/Microsoft.AspNetCore.OpenApi.Generated.cs,**/Program.cs,**/OpenApiXmlCommentSupport.generated.cs
          - task: SonarCloudPrepare@4
            inputs:
              SonarQube: 'SonarCloud'
              organization: 'ratheeshazure01'
              scannerMode: 'cli'
              cliScannerVersion: '8.0.1.6346'
              configMode: 'manual'
              cliProjectKey: '$(SonarCloudProjectKey)'
              cliProjectName: 'AppAccelerator'
              cliSources: '.$(projectPath)/**'
              extraProperties: |
                sonar.cs.opencover.reportsPaths=$(Agent.TempDirectory)/**/*opencover.xml
                sonar.exclusions=**/bin/**,**/obj/** ,**/Program.cs,**/OpenApiXmlCommentSupport.generated.cs
                sonar.coverage.exclusions=**/Microsoft.AspNetCore.OpenApi.Generated.cs,**/Program.cs,**/OpenApiXmlCommentSupport.generated.cs
          - task: DotNetCoreCLI@2
            displayName: 'Build solution'
            inputs:
              command: 'build'
              projects: '$(projectPath)/**/*.csproj'
              arguments: '--configuration $(buildConfiguration) --no-restore'

          - task: DotNetCoreCLI@2
            displayName: 'Run Unit Tests'
            inputs:
              command: 'test'
              projects: '$(testProjectPath)/Payment.Processing.API.UnitTests.csproj'
              arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage" --settings $(testProjectPath)/coverage.runsettings'
              publishTestResults: true
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFiles: '$(Agent.TempDirectory)/**/*.trx' # Use the trx file generated by the logger
              testRunTitle: '.NET Unit Tests'
          - task: PublishCodeCoverageResults@2
            displayName: 'Publish Code Coverage'
            inputs:
              summaryFileLocation: '$(Agent.TempDirectory)/**/*coverage.cobertura.xml'
          
          - task: PowerShell@2
            displayName: 'Check Code Coverage Threshold (85%)'
            inputs:
              targetType: 'inline'
              script: |
                $coverageFile = Get-ChildItem -Path "$(Agent.TempDirectory)" -Filter "*coverage.cobertura.xml" -Recurse | Select-Object -First 1
                
                if ($null -eq $coverageFile) {
                  Write-Error "Code coverage file not found"
                  exit 1
                }
                
                [xml]$coverage = Get-Content $coverageFile.FullName
                $lineRate = [float]$coverage.coverage.'line-rate'
                $coveragePercentage = $lineRate * 100
                
                Write-Host "Code Coverage: $([Math]::Round($coveragePercentage, 2))%"
                
                if ($coveragePercentage -lt 85) {
                  Write-Error "Code coverage $([Math]::Round($coveragePercentage, 2))% is below the required threshold of 85%"
                  exit 1
                }
                
                Write-Host "âœ“ Code coverage threshold met"
              failOnStderr: true
          - task: SonarCloudPublish@4
            displayName: 'Complete SonarCloud Analysis'
            inputs:
              pollingTimeoutSec: '300'
          - task: dependency-check-build-task@6
            displayName: 'Dependency Check'
            inputs:
              projectName: 'AppAccelerator'
              scanPath: '**/*.csproj'
              format: 'ALL'
              failOnCVSS: '8'
              enableVerbose: true
          - task: DotNetCoreCLI@2
            displayName: 'Publish API'
            inputs:
              command: 'publish'
              projects: '$(apiProjectPath)/Payment.Processing.API.csproj'
              publishWebProjects: false
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
              zipAfterPublish: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Artifacts'
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: $(artifactName)
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'Deploy to Azure App Service'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployToAppService
        displayName: 'Deploy API to App Service'
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  inputs:
                    buildType: 'current'
                    artifactName: '$(artifactName)'
                    targetPath: '$(Pipeline.Workspace)'
                - task: AzureRmWebAppDeployment@4
                  inputs:
                    ConnectionType: 'AzureRM'
                    azureSubscription: 'AzureAppAccelerator'
                    appType: 'webApp'
                    WebAppName: 'ase-app-accelerator-dev'
                    packageForLinux: '$(Pipeline.Workspace)/$(artifactName)/**/*.zip'
               
